component CardDisplay inherits Rectangle {
    in property <string> card_value: "";
    in property <bool> face_up: true;
    in property <bool> is_red: false;
    
    background: face_up ? (card_value != "" ? #ffffff : #1a1a2e) : #1a1a2e;
    border-radius: 3px;
    border-width: 1px;
    border-color: face_up ? #cccccc : #333;
    
    if face_up && card_value != "" : Text {
        text: card_value;
        font-size: 10px;
        font-weight: 700;
        color: is_red ? #dc143c : #1a1a1a;
        horizontal-alignment: center;
        vertical-alignment: center;
    }
}

component PlayerAreaCompact inherits Rectangle {
    in property <string> name: "";
    in property <float> chips: 0;
    in property <float> current_bet: 0;
    in property <string> hole_card1: "";
    in property <string> hole_card2: "";
    in property <bool> hole_card1_red: false;
    in property <bool> hole_card2_red: false;
    in property <bool> is_acting: false;
    in property <bool> is_folded: false;
    in property <bool> is_dealer: false;
    
    background: is_acting ? #4a3a00 : #2a2a2a;
    border-radius: 6px;
    border-width: 1px;
    border-color: is_acting ? #ffd700 : #444;
    
    if is_dealer : Rectangle {
        width: 14px;
        height: 14px;
        x: 3px;
        y: 3px;
        border-radius: 7px;
        background: #ffffff;
        border-width: 1px;
        border-color: #ffd700;
        
        Text {
            text: "D";
            font-size: 7px;
            font-weight: 700;
            color: #1a1a1a;
            horizontal-alignment: center;
            vertical-alignment: center;
        }
    }
    
    Text {
        text: name;
        font-size: 9px;
        font-weight: 600;
        color: #ffffff;
        x: (parent.width - self.width) / 2;
        y: 3px;
    }
    
    Text {
        text: chips;
        font-size: 10px;
        font-weight: 600;
        color: #ffd700;
        x: (parent.width - self.width) / 2;
        y: 14px;
    }
    
    if current_bet > 0 : Text {
        text: "Bet: " + current_bet;
        font-size: 7px;
        color: #aaaaaa;
        x: (parent.width - self.width) / 2;
        y: 26px;
    }
    
    Rectangle {
        x: (parent.width - 48px) / 2;
        y: 36px;
        width: 48px;
        height: 28px;
        
        CardDisplay {
            card_value: hole_card1;
            face_up: true;
            is_red: hole_card1_red;
            x: 0;
            y: 0;
            width: 22px;
            height: 26px;
        }
        CardDisplay {
            card_value: hole_card2;
            face_up: true;
            is_red: hole_card2_red;
            x: 24px;
            y: 0;
            width: 22px;
            height: 26px;
        }
    }
    
    if is_folded : Text {
        text: "FOLDED";
        font-size: 10px;
        font-weight: 600;
        color: #ff4444;
        x: (parent.width - self.width) / 2;
        y: (parent.height - self.height) / 2;
    }
    
    if is_acting : Rectangle {
        width: 6px;
        height: 6px;
        x: parent.width - 10px;
        y: 4px;
        border-radius: 3px;
        background: #00ff00;
    }
}

component ActionButton inherits Rectangle {
    in property <string> text: "";
    in property <color> bg_color: #4a6fa5;
    in property <bool> enabled: true;
    
    background: enabled ? bg_color : #555555;
    border-radius: 4px;
    
    Text {
        text: parent.text;
        font-size: 11px;
        font-weight: 600;
        color: #ffffff;
        horizontal-alignment: center;
        vertical-alignment: center;
    }
}

component BetSlider inherits Rectangle {
    in property <float> value: 0;
    in property <float> min: 0;
    in property <float> max: 100;
    in property <string> label: "";
    
    callback value_changed(float);
    
    background: #1a1a1a;
    border-radius: 4px;
    
    track := Rectangle {
        width: parent.width - 8px;
        height: 6px;
        x: 4px;
        y: 18px;
        background: #444;
        border-radius: 3px;
        
        fill := Rectangle {
            width: (parent.width - 8px) * ((value - min) / (max - min));
            height: 6px;
            background: #ffd700;
            border-radius: 3px;
        }
        
        TouchArea {
            width: parent.width;
            height: parent.height;
            pointer-event(event) => {
                if event.kind == PointerEventKind.down {
                    let pct = self.pressed_x / self.width;
                    let new_value = min + pct * (max - min);
                    value_changed(new_value);
                }
            }
        }
    }
    
    handle := Rectangle {
        x: 4px + (parent.width - 8px) * ((value - min) / (max - min)) - 6px;
        y: 16px;
        width: 12px;
        height: 10px;
        background: #ffffff;
        border-radius: 2px;
        border-width: 1px;
        border-color: #888;
        
        TouchArea {
            width: parent.width;
            height: parent.height;
            pointer-event(event) => {
                if event.kind == PointerEventKind.down {
                    let pct = self.pressed_x / self.width;
                    let new_value = min + pct * (max - min);
                    value_changed(new_value);
                }
            }
            moved => {
                let pct = self.pressed_x / self.width;
                let new_value = min + pct * (max - min);
                value_changed(new_value);
            }
        }
    }
    
    Text {
        text: label + ": " + value;
        font-size: 10px;
        color: #ffd700;
        x: 4px;
        y: 2px;
    }
}

export component PokerApp inherits Window {
    in property <string> player1_name: "Player 1";
    in property <string> player2_name: "Player 2";
    in property <float> player1_chips: 10000;
    in property <float> player2_chips: 10000;
    in property <float> pot_size: 0;
    in property <float> current_bet: 0;
    in property <string> game_stage: "preflop";
    in property <int> dealer_position: 0;
    in property <string> message: "Game Starting...";
    in property <bool> show_hole_cards: true;
    
    in property <string> p1_card1: "";
    in property <string> p1_card2: "";
    in property <string> p2_card1: "";
    in property <string> p2_card2: "";
    
    in property <bool> p1_card1_red: false;
    in property <bool> p1_card2_red: false;
    in property <bool> p2_card1_red: false;
    in property <bool> p2_card2_red: false;
    
    in property <string> flop1: "";
    in property <string> flop2: "";
    in property <string> flop3: "";
    in property <string> turn: "";
    in property <string> river: "";
    
    in property <bool> flop1_red: false;
    in property <bool> flop2_red: false;
    in property <bool> flop3_red: false;
    in property <bool> turn_red: false;
    in property <bool> river_red: false;
    
    in property <bool> p1_acting: false;
    in property <bool> p2_acting: false;
    in property <bool> p1_folded: false;
    in property <bool> p2_folded: false;
    in property <float> p1_current_bet: 0;
    in property <float> p2_current_bet: 0;
    
    in property <bool> can_check: false;
    in property <bool> can_call: false;
    in property <bool> can_bet: false;
    in property <bool> can_raise: false;
    in property <bool> can_fold: false;
    in property <float> call_amount: 0;
    in-out property <float> bet_amount: 0;
    in property <float> min_bet: 0;
    in property <float> max_bet: 0;
    in property <float> pot_odds: 0;
    
    callback start_game();
    callback bet_changed(float);
    callback fold();
    callback check();
    callback call();
    callback bet();
    callback raise();
    
    title: "Poker Simulation";
    min-width: 320px;
    min-height: 480px;
    
    Rectangle {
        width: parent.width;
        height: parent.height;
        background: #1a472a;
        
        Rectangle {
            width: min(parent.width * 0.96, 380px);
            height: parent.height - 70px;
            x: (parent.width - self.width) / 2;
            y: 2px;
            border-radius: 16px;
            background: #2d5a3d;
            border-width: 6px;
            border-color: #8b4513;
            
            Rectangle {
                width: parent.width - 14px;
                height: parent.height - 14px;
                x: 7px;
                y: 7px;
                border-radius: 12px;
                background: #356e4b;
            }
            
            PlayerAreaCompact {
                name: player2_name;
                chips: player2_chips;
                current_bet: p2_current_bet;
                hole_card1: p2_card1;
                hole_card2: p2_card2;
                hole_card1_red: p2_card1_red;
                hole_card2_red: p2_card2_red;
                is_acting: p2_acting;
                is_folded: p2_folded;
                is_dealer: dealer_position == 1;
                x: (parent.width - min(parent.width * 0.4, 135px)) / 2;
                y: 8px;
                width: min(parent.width * 0.4, 135px);
                height: min(parent.height * 0.16, 58px);
            }
            
            Rectangle {
                width: min(parent.width * 0.25, 85px);
                height: 18px;
                x: (parent.width - self.width) / 2;
                y: parent.height * 0.3;
                border-radius: 5px;
                background: #1a1a1a;
                border-width: 1px;
                border-color: #ffd700;
                
                Text {
                    text: "Pot: " + pot_size;
                    font-size: 10px;
                    font-weight: 600;
                    color: #ffd700;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }
            
            Rectangle {
                width: min(parent.width * 0.92, 300px);
                height: min(parent.height * 0.08, 45px);
                x: (parent.width - self.width) / 2;
                y: parent.height * 0.38;
                
                CardDisplay {
                    card_value: flop1;
                    face_up: flop1 != "";
                    is_red: flop1_red;
                    x: 0;
                    y: 0;
                    width: parent.width * 0.16;
                    height: 40px;
                }
                CardDisplay {
                    card_value: flop2;
                    face_up: flop2 != "";
                    is_red: flop2_red;
                    x: parent.width * 0.205;
                    y: 0;
                    width: parent.width * 0.16;
                    height: 40px;
                }
                CardDisplay {
                    card_value: flop3;
                    face_up: flop3 != "";
                    is_red: flop3_red;
                    x: parent.width * 0.41;
                    y: 0;
                    width: parent.width * 0.16;
                    height: 40px;
                }
                
                CardDisplay {
                    card_value: turn;
                    face_up: turn != "";
                    is_red: turn_red;
                    x: parent.width * 0.615;
                    y: 0;
                    width: parent.width * 0.16;
                    height: 40px;
                }
                
                CardDisplay {
                    card_value: river;
                    face_up: river != "";
                    is_red: river_red;
                    x: parent.width * 0.82;
                    y: 0;
                    width: parent.width * 0.16;
                    height: 40px;
                }
            }
            
            Rectangle {
                width: min(parent.width * 0.18, 60px);
                height: 14px;
                x: (parent.width - self.width) / 2;
                y: parent.height * 0.06;
                border-radius: 4px;
                background: #4a6fa5;
                
                Text {
                    text: game_stage;
                    font-size: 7px;
                    font-weight: 600;
                    color: #ffffff;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }
            
            Rectangle {
                width: min(parent.width * 0.5, 160px);
                height: 16px;
                x: (parent.width - self.width) / 2;
                y: parent.height * 0.52;
                border-radius: 4px;
                background: rgba(0, 0, 0, 0.6);
                border-width: 1px;
                border-color: rgba(255, 255, 255, 0.2);
                
                Text {
                    text: message;
                    font-size: 8px;
                    color: #ffffff;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }
            
            PlayerAreaCompact {
                name: player1_name;
                chips: player1_chips;
                current_bet: p1_current_bet;
                hole_card1: p1_card1;
                hole_card2: p1_card2;
                hole_card1_red: p1_card1_red;
                hole_card2_red: p1_card2_red;
                is_acting: p1_acting;
                is_folded: p1_folded;
                is_dealer: dealer_position == 0;
                x: (parent.width - min(parent.width * 0.4, 135px)) / 2;
                y: parent.height - 66px;
                width: min(parent.width * 0.4, 135px);
                height: min(parent.height * 0.16, 58px);
            }
        }
        
        Rectangle {
            width: parent.width;
            height: 68px;
            y: parent.height - 68px;
            background: rgba(0, 0, 0, 0.5);
            
            BetSlider {
                x: 8px;
                y: 4px;
                width: parent.width - 16px;
                height: 24px;
                value: bet_amount;
                min: min_bet;
                max: max_bet;
                label: "Bet";
                value_changed(new_value) => {
                    bet_amount = new_value;
                    bet_changed(new_value);
                }
            }
            
            Rectangle {
                x: 6px;
                y: 30px;
                width: parent.width - 12px;
                height: 36px;
                
                ActionButton {
                    text: "Start";
                    bg_color: #4a7a5a;
                    enabled: true;
                    x: 0;
                    y: 0;
                    width: min(parent.width * 0.18, 60px);
                    height: 34px;

                    TouchArea {
                        width: parent.width;
                        height: parent.height;
                        clicked => {
                            start_game();
                        }
                    }
                }
                ActionButton {
                    text: "Fold";
                    bg_color: #aa4444;
                    enabled: can_fold;
                    x: min(parent.width * 0.2, 66px);
                    y: 0;
                    width: min(parent.width * 0.18, 60px);
                    height: 34px;

                    TouchArea {
                        width: parent.width;
                        height: parent.height;
                        clicked => {
                            fold();
                        }
                    }
                }
                ActionButton {
                    text: "Check";
                    bg_color: #4a7fa5;
                    enabled: can_check;
                    x: min(parent.width * 0.4, 132px);
                    y: 0;
                    width: min(parent.width * 0.18, 60px);
                    height: 34px;

                    TouchArea {
                        width: parent.width;
                        height: parent.height;
                        clicked => {
                            check();
                        }
                    }
                }
                ActionButton {
                    text: "Call";
                    bg_color: #4a9a5a;
                    enabled: can_call;
                    x: min(parent.width * 0.6, 198px);
                    y: 0;
                    width: min(parent.width * 0.18, 60px);
                    height: 34px;

                    TouchArea {
                        width: parent.width;
                        height: parent.height;
                        clicked => {
                            call();
                        }
                    }
                }
                ActionButton {
                    text: "Raise";
                    bg_color: #9a7a4a;
                    enabled: can_raise;
                    x: min(parent.width * 0.8, 264px);
                    y: 0;
                    width: min(parent.width * 0.18, 60px);
                    height: 34px;

                    TouchArea {
                        width: parent.width;
                        height: parent.height;
                        clicked => {
                            raise();
                        }
                    }
                }
            }
            
            Rectangle {
                x: 6px;
                y: 68px;
                width: parent.width - 12px;
                height: 16px;
                
                Text {
                    text: "Pot: " + pot_size + " | Odds: " + (pot_odds * 100).round() + "%";
                    font-size: 9px;
                    color: #ffd700;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }
        }
    }
}
